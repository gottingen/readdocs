# fault tolerance

Scylla根据选择的复制策略复制数据。该策略将确定复制数据的位置。 Scylla在哈希环中运行节点。所有节点都相等：没有主，从或副本集。

复制因子（RF）等于要复制数据（行和分区）的节点数。数据被复制到多个（RF = N）节点。

RF为1表示群集中一行只有一个副本，并且如果该节点受损或发生故障，则无法恢复数据。 RF = 2表示集群中一行有两个副本。在大多数系统或类似系统
中，RF至少为3。

数据总是自动复制。可能会对存储在任何复制节点上的数据进行读取或写入操作。

![1-write](/scylla/images/1-write_op_RF_31.jpg)

在上面的示例中，我们的客户端发送了一个将分区1写入节点V的请求； 1的数据复制到节点W，X和Z。我们的复制因子（RF）为3。在此图中，V是协调器节
点，而不是复制器节点。但是，复制器节点也可以是协调器节点，并且经常是。

![2-read](/scylla/images/2-read_op_RF_3.jpg)

在读取操作期间，客户端将请求发送到协调器。有效地因为RF = 3，所以3个节点响应读取请求。

一致性级别（CL）确定群集中的多少个副本在被认为成功之前必须确认读或写操作。

* ANY
* QUORUM
* ONE
* LOCAL_ONE
* LOCAL_QUORUM
* EACH_QUORUM
* ALL


    NOTE
    
    无论一致性级别如何，都会始终将写入发送到所有复制副本，如复制因子所设置的那样。一致性级别控制客户端何时确认，而不更新多少副本。
    
在写操作期间，协调器与副本进行通信（副本的数量取决于复制因子）。当指定数量的副本确认写入时，写入成功。

![3-write](/scylla/images/3-write_op_RF_3_CL_1.jpg)

在上图中，双箭头指示写操作请求从客户端进入协调器，并返回确认。由于一致性级别为1，因此协调器V仅必须等待写入发送到群集中的单个节点W并由其
响应。

由于RF = 3，我们的分区1也被写入节点X和Z，但是协调器不需要等待它们的响应来确认写入操作成功。实际上，在协调者确认客户端之后，来自节点X和
Z的确认可以在以后的时间到达协调者。

当我们的Consistency Level设置为QUORUM时，协调器必须等待大多数节点确认写入，然后才能认为写入成功。由于我们的复制因子为3，因此我们必须
等待2个确认（不需要返回第三个确认）：

![4-write](/scylla/images/4-write_op_RF_3_CL_Quorum.jpg)

在读取操作期间，协调器仅与足够多的副本进行通信以确保满足所需的一致性级别。然后将数据返回给客户端。


![5-read](/scylla/images/5-read_op_RF_3_CL_2.jpg)

在CQL中，每个操作的一致性级别都是可调的。这称为可调一致性。有时响应延迟更为重要，因此有必要在每个查询或操作级别上调整设置，以覆盖键空间
甚至数据中心范围的一致性设置。换句话说，“一致性级别”设置允许您在一致性与延迟权衡之间选择一个点。


    NOTE
    仲裁是整个群集中的全局一致性级别。这意味着，如果您有两个数据中心，则两个数据中心中的所有节点均计入法定多数。例如，有一个群集，其中有
    两个DC，一个DC中有三个节点，另一个DC中有两个节点。如果较小的DC失败，则请求仍将在Quorum下传递为3> 5/2。

一致性级别和复制因子都会影响性能。一致性级别和/或复制因子越低，读取或写入操作越快。但是，如果节点发生故障，则容错能力将降低。


一致性级别本身会影响可用性。较高的一致性级别（需要更多的节点才能联机）意味着可用性较低，对节点故障的容忍度也较小。较低的一致性级别意味着
更多的可用性和更多的容错能力。

下表显示了哪些一致性级别可用于读取或写入操作：

Consistency Level	| Read	| Write
:--- | :--- | :---
Any	|No	|Yes
1	|Yes	|Yes
2	|Yes	|Yes
3	|Yes	|Yes
QUORUM	|Yes	|Yes
LOCAL_ONE	|Yes	|Yes
LOCAL_QUORUM	|Yes	|Yes
EACH_QUORUM	|No	|Yes
ALL	|Yes	|Yes

与许多分布式数据库系统一样，Scylla遵循CAP定理。 CAP定理是在分布式系统中数据的一致性，可用性和分区容忍度相互依赖的概念。增加其中任何两
个因素将减少第三个因素。

Scylla通过以下方式遵守CAP定理：

![6-cap](/scylla/images/6-CAP_Theorem.jpg)

Scylla选择可用性和分区容忍度而不是一致性，例如：

* 在网络分区期间，要保持一致性和高可用性是不可能的；
* 如果我们牺牲一致性，那么我们将变得高度可用。

需要围绕Scylla的数据建模设计应用程序，但最终结果是应用程序永远不会崩溃。

## 其他资源

